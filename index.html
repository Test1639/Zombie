<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Zombie Shooter 2D</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      width: 100vw;
      height: 100vh;
      background: black;
      touch-action: none;
    }
    canvas {
      display: block;
      width: 100vw;
      height: 100vh;
      image-rendering: pixelated;
    }
    .joystick-zone {
      position: absolute;
      width: 50%;
      height: 100%;
      top: 0;
      z-index: 10;
    }
    #leftZone { left: 0; }
    #rightZone { right: 0; }
  </style>
</head>
<body>
  <div id="leftZone" class="joystick-zone"></div>
  <div id="rightZone" class="joystick-zone"></div>

  <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/nipplejs@0.9.0/dist/nipplejs.min.js"></script>
  <script>
    const gameWidth = 896;
    const gameHeight = 512;

    const config = {
      type: Phaser.AUTO,
      width: gameWidth,
      height: gameHeight,
      scale: {
        mode: Phaser.Scale.FIT,
        autoCenter: Phaser.Scale.CENTER_BOTH
      },
      physics: {
        default: 'arcade',
        arcade: {
          gravity: { y: 0 },
          debug: false
        }
      },
      pixelArt: true,
      backgroundColor: '#000000',
      scene: { preload, create, update }
    };

    const game = new Phaser.Game(config);

    let player, bullets, zombies, healthPacks, ammoBoxes;
    let moveVelocity = { x: 0, y: 0 };
    let aimAngle = null;
    let lastFired = 0;
    let health = 100, ammo = 6, maxAmmo = 6, score = 0;
    let healthBar, scoreText, ammoText;

    function preload() {
      this.load.image('bg', 'assets/background_layer.png');
      this.load.image('mg', 'assets/midground_layer.png');
      this.load.image('fg', 'assets/foreground_layer.png');
      this.load.image('player', 'assets/soldier.png');
      this.load.image('zombie', 'assets/zombie.png');
      this.load.image('bullet', 'assets/bullet.png');
      this.load.image('healthPack', 'assets/healthPack.png');
      this.load.image('ammoBox', 'assets/ammoBox.png');
    }

    function create() {
      this.add.image(0, 0, 'bg').setOrigin(0).setDisplaySize(gameWidth, gameHeight);
      this.add.image(0, 0, 'mg').setOrigin(0).setDisplaySize(gameWidth, gameHeight);
      this.add.image(0, 0, 'fg').setOrigin(0).setDisplaySize(gameWidth, gameHeight);

      player = this.physics.add.sprite(150, gameHeight - 100, 'player');
      player.setScale(0.35);
      player.setCollideWorldBounds(true);

      bullets = this.physics.add.group();
      zombies = this.physics.add.group();
      healthPacks = this.physics.add.group();
      ammoBoxes = this.physics.add.group();

      this.physics.add.overlap(bullets, zombies, hitZombie, null, this);
      this.physics.add.overlap(player, zombies, playerHit, null, this);
      this.physics.add.overlap(player, healthPacks, pickupHealth, null, this);
      this.physics.add.overlap(player, ammoBoxes, pickupAmmo, null, this);

      scoreText = this.add.text(20, 20, 'Score: 0', { font: '20px Arial', fill: '#fff' });
      ammoText = this.add.text(20, 45, 'Ammo: ' + ammo, { font: '20px Arial', fill: '#fff' });
      healthBar = this.add.graphics();
      updateHealthBar();

      this.time.addEvent({
        delay: 1500,
        callback: () => {
          const z = zombies.create(gameWidth + 50, gameHeight - 100, 'zombie');
          z.setVelocityX(-100);
          z.setScale(0.35);
        },
        loop: true
      });

      if (typeof nipplejs !== 'undefined') setupJoysticks();
    }

    function update(time) {
      if (player) player.setVelocity(moveVelocity.x * 200, moveVelocity.y * 200);
      if (aimAngle !== null && time > lastFired + 300 && ammo > 0) {
        fireBullet(aimAngle); lastFired = time;
      }
    }

    function fireBullet(angle) {
      const bullet = bullets.create(player.x, player.y, 'bullet');
      game.physics.velocityFromRotation(angle, 400, bullet.body.velocity);
      ammo--; ammoText.setText('Ammo: ' + ammo);
    }

    function hitZombie(bullet, zombie) {
      bullet.destroy(); zombie.destroy(); score++;
      scoreText.setText('Score: ' + score);
    }

    function playerHit(player, zombie) {
      zombie.destroy(); health -= 10;
      updateHealthBar();
      if (health <= 0) game.scene.restart();
    }

    function pickupHealth(player, pack) {
      pack.destroy();
      health = Math.min(100, health + 25);
      updateHealthBar();
    }

    function pickupAmmo(player, box) {
      box.destroy();
      ammo = Math.min(maxAmmo, ammo + 3);
      ammoText.setText('Ammo: ' + ammo);
    }

    function updateHealthBar() {
      healthBar.clear();
      const color = health > 40 ? 0x2ecc71 : 0xe74c3c;
      healthBar.fillStyle(color);
      healthBar.fillRect(20, 70, health * 2, 20);
      healthBar.lineStyle(2, 0xffffff);
      healthBar.strokeRect(20, 70, 200, 20);
    }

    function setupJoysticks() {
      const left = nipplejs.create({ zone: document.getElementById('leftZone'), mode: 'dynamic' });
      const right = nipplejs.create({ zone: document.getElementById('rightZone'), mode: 'dynamic' });

      left.on('move', (_, data) => {
        moveVelocity.x = Math.cos(data.angle.radian);
        moveVelocity.y = Math.sin(data.angle.radian);
      }).on('end', () => moveVelocity = { x: 0, y: 0 });

      right.on('move', (_, data) => {
        aimAngle = data.angle.radian;
      }).on('end', () => aimAngle = null);
    }
  </script>
</body>
</html>
