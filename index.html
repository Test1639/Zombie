let leftTouchId = null, rightTouchId = null;
let leftStart = null, rightStart = null;

const leftJoy = document.getElementById("leftJoystick");
const rightJoy = document.getElementById("rightJoystick");

leftJoy.addEventListener("touchstart", e => {
  for (const touch of e.changedTouches) {
    if (leftTouchId === null) {
      leftTouchId = touch.identifier;
      leftStart = { x: touch.clientX, y: touch.clientY };
    }
  }
});

leftJoy.addEventListener("touchmove", e => {
  for (const touch of e.changedTouches) {
    if (touch.identifier === leftTouchId) {
      const dx = touch.clientX - leftStart.x;
      const dy = touch.clientY - leftStart.y;

      controls.forward = dy < -20;
      controls.back = dy > 20;
      controls.left = dx < -20;
      controls.right = dx > 20;
    }
  }
});

leftJoy.addEventListener("touchend", e => {
  for (const touch of e.changedTouches) {
    if (touch.identifier === leftTouchId) {
      controls.forward = controls.back = controls.left = controls.right = false;
      leftTouchId = null;
    }
  }
});

rightJoy.addEventListener("touchstart", e => {
  for (const touch of e.changedTouches) {
    if (rightTouchId === null) {
      rightTouchId = touch.identifier;
      rightStart = { x: touch.clientX, y: touch.clientY };
    }
  }
});

rightJoy.addEventListener("touchmove", e => {
  for (const touch of e.changedTouches) {
    if (touch.identifier === rightTouchId) {
      const dx = touch.clientX - rightStart.x;
      camera.rotation.y -= dx * 0.005;
      rightStart = { x: touch.clientX, y: touch.clientY };
    }
  }
});

rightJoy.addEventListener("touchend", e => {
  for (const touch of e.changedTouches) {
    if (touch.identifier === rightTouchId) {
      rightTouchId = null;
    }
  }
});
