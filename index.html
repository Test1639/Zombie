<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Endless Zombie Shooter 2D</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      touch-action: manipulation;
    }
    canvas {
      border: 2px solid #2ecc71;
      display: block;
      margin: auto;
    }
    #touchControls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 20px;
      z-index: 10;
    }
    .btn {
      width: 100px;
      height: 100px;
      font-size: 24px;
      background: #2c3e50;
      color: white;
      border: 3px solid #ecf0f1;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <div id="touchControls">
    <button class="btn" id="fireBtn">FIRE</button>
    <button class="btn" id="reloadBtn">RELOAD</button>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.js"></script>
  <script>
    const config = {
      type: Phaser.AUTO,
      width: 896,
      height: 512,
      pixelArt: true,
      physics: {
        default: 'arcade',
        arcade: {
          gravity: { y: 0 },
          debug: false
        }
      },
      scene: { preload, create, update }
    };

    const game = new Phaser.Game(config);

    let player, cursors, bullets, zombies;
    let health = 100, ammo = 6, maxAmmo = 6, score = 0;
    let fireKey, reloadKey, reloadCooldown = false;
    let healthBar, ammoText, scoreText;
    let fireBtn, reloadBtn;

    function preload() {
      this.load.image('bg', 'assets/background_layer.png');
      this.load.image('mg', 'assets/midground_layer.png');
      this.load.image('fg', 'assets/foreground_layer.png');
      this.load.image('player', 'assets/soldier.png');
      this.load.image('zombie', 'assets/soldier.png');
      this.load.image('bullet', 'assets/bullet.png');
    }

    function create() {
      createBackgroundLayer.call(this, 'bg', '#2c3e50', 0.2);
      createBackgroundLayer.call(this, 'mg', '#34495e', 0.4);
      createBackgroundLayer.call(this, 'fg', '#7f8c8d', 0.6);

      player = this.physics.add.sprite(100, 256, 'player');
      player.setCollideWorldBounds(true);

      cursors = this.input.keyboard.createCursorKeys();
      fireKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
      reloadKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.R);

      fireBtn = document.getElementById('fireBtn');
      reloadBtn = document.getElementById('reloadBtn');
      fireBtn.addEventListener('click', () => fireBullet.call(this));
      reloadBtn.addEventListener('click', () => reloadAmmo.call(this));

      bullets = this.physics.add.group();
      zombies = this.physics.add.group();

      this.physics.add.overlap(bullets, zombies, hitZombie, null, this);
      this.physics.add.overlap(player, zombies, playerHit, null, this);

      ammoText = this.add.text(10, 10, 'Ammo: ' + ammo, { font: '20px Arial', fill: '#fff' });
      scoreText = this.add.text(10, 40, 'Score: ' + score, { font: '20px Arial', fill: '#fff' });
      healthBar = this.add.graphics();
      updateHealthBar();

      this.fpsText = this.add.text(800, 10, '', { font: '16px Courier', fill: '#00ff00' });

      this.time.addEvent({
        delay: 1000,
        callback: spawnZombie,
        callbackScope: this,
        loop: true
      });
    }

    function update(time, delta) {
      this.fpsText.setText(`FPS: ${Math.floor(this.game.loop.actualFps)}`);

      if (cursors.up.isDown) player.setVelocityY(-200);
      else if (cursors.down.isDown) player.setVelocityY(200);
      else player.setVelocityY(0);

      if (cursors.left.isDown) player.setVelocityX(-200);
      else if (cursors.right.isDown) player.setVelocityX(200);
      else player.setVelocityX(0);

      if (Phaser.Input.Keyboard.JustDown(fireKey)) fireBullet.call(this);
      if (Phaser.Input.Keyboard.JustDown(reloadKey)) reloadAmmo.call(this);
    }

    function fireBullet() {
      if (ammo <= 0 || reloadCooldown) return;
      const bullet = bullets.create(player.x + 16, player.y, 'bullet');
      bullet.setVelocityX(400);
      ammo--;
      ammoText.setText('Ammo: ' + ammo);
    }

    function reloadAmmo() {
      if (ammo === maxAmmo || reloadCooldown) return;
      reloadCooldown = true;
      setTimeout(() => {
        ammo = maxAmmo;
        ammoText.setText('Ammo: ' + ammo);
        reloadCooldown = false;
      }, 1000);
    }

    function spawnZombie() {
      const zombie = zombies.create(896, Phaser.Math.Between(50, 462), 'zombie');
      zombie.setVelocityX(Phaser.Math.Between(-100, -150));
    }

    function hitZombie(bullet, zombie) {
      bullet.destroy();
      zombie.destroy();
      score++;
      scoreText.setText('Score: ' + score);
    }

    function playerHit(player, zombie) {
      zombie.destroy();
      health -= 10;
      updateHealthBar();
      if (health <= 0) game.scene.restart();
    }

    function updateHealthBar() {
      healthBar.clear();
      const color = health > 40 ? 0x2ecc71 : 0xe74c3c;
      healthBar.fillStyle(color);
      healthBar.fillRect(10, 70, health * 2, 20);
      healthBar.lineStyle(2, 0x000000);
      healthBar.strokeRect(10, 70, 200, 20);
    }

    function createBackgroundLayer(key, fallbackColor, scrollFactor) {
      if (this.textures.exists(key)) {
        const bg = this.add.tileSprite(0, 0, 896, 512, key).setOrigin(0).setScrollFactor(scrollFactor);
      } else {
        const rect = this.add.rectangle(0, 0, 896, 512, Phaser.Display.Color.HexStringToColor(fallbackColor).color);
        rect.setOrigin(0).setScrollFactor(scrollFactor);
        console.log(`Missing ${key} asset. Using fallback color.`);
      }
    }
  </script>
</body>
</html>
